name: UI Tests
on:
  push:
    branches:
      - develop

# Self hosted runners seem to have trouble managing certs the way github hosted runners do
# So this job is setup expecting the certs to be installed on the machine and accessible to Xcode
jobs:
  deploy:
    name: Run UI Tests
    runs-on: self-hosted
    steps:
      - name: Select Xcode version
        run: sudo xcode-select -s '/Applications/Xcode.app/Contents/Developer'
        
      - name: Checkout repository
        uses: actions/checkout@v4.1.1

      - name: Setup Global Env
        run: |
          echo "SEED_PHRASE_1=${{ secrets.UITEST_SEED_PHRASE_1 }}" >> $GITHUB_ENV
          echo "SEED_PHRASE_PASSWORD=${{ secrets.UITEST_SEED_PHRASE_PASSWORD }}" >> $GITHUB_ENV
          echo "GMAIL_ADDRESS=${{ secrets.UITEST_GMAIL_ADDRESS }}" >> $GITHUB_ENV
          echo "GMAIL_PASSWORD=${{ secrets.UITEST_GMAIL_PASSWORD }}" >> $GITHUB_ENV

      - name: Build and run tests
        run: |
          xcodebuild -project "Kukai Mobile.xcodeproj" \
          -sdk iphonesimulator -destination "platform=iOS Simulator,name=iPhone 16,OS=18.5" \
          -scheme "Kukai Mobile Beta" \
          -resultBundlePath TestResults \
          -configuration Beta \
          -archivePath $PWD/build/Kukai-mobile.xcarchive \
          clean \
          archive \
          test \
          SEED_PHRASE_1="$SEED_PHRASE_1" \
          SEED_PHRASE_PASSWORD="$SEED_PHRASE_PASSWORD" \
          GMAIL_ADDRESS="$GMAIL_ADDRESS" \
          GMAIL_PASSWORD="$GMAIL_PASSWORD"

      - name: Upload xcresult file
        if: ${{ success() || failure() }}
        id: upload_artifact
        uses: actions/upload-artifact@v4
        with:
          name: TestResults-${{ github.run_number }}.xcresult
          path: TestResults.xcresult
        
        # Run xcresultparser on the output file to generate a markdown summary
        # Grab the artifact URL from the previous step (new addtion to v4)
        # Use a bot webhook to post the details to slack, with a link to download the full thing if needed
        # Couldn't figure out how to upload the file directly to slack, the github action integration just sliently fails to everything without posting any error codes
      - name: Report to slack
        if: ${{ success() || failure() }}
        run: |
            xcr_markdown=$(xcresultparser --output-format markdown --failed-tests-only "TestResults.xcresult")
            curl -0 -v -X POST ${{ secrets.SLACK_INCOMING_WEBHOOK }} \
            -H "Expect:" \
            -H 'Content-Type: application/json; charset=utf-8' \
            --data-raw '
            {
                "blocks": [
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "Automated UI test run complete\n\n'"${xcr_markdown}"'"
                        }
                    },
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "Download full file from runner [here](${{ steps.upload_artifact.outputs.artifact-url }})"
                        }
                    }
                ]
            }'
